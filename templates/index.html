<!DOCTYPE html>
<html>
  <head>
    <title>Moon Chemical Abundance Map</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      .controls {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 0 0 10px 0;
      }

      .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 1;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border-radius: 5px;
        color: white;
      }

      #info-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 5px;
      }

      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
      }

      select,
      button {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 5px;
        margin: 5px;
        border-radius: 4px;
      }

      select:hover,
      button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      #colorScale {
        width: 200px;
        height: 20px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <h3>Moon Chemical Abundance</h3>
      <div>
        <select id="primaryElement">
          <option value="">Select Primary Element</option>
          <option value="Fe">Fe</option>
          <option value="Ti">Ti</option>
          <option value="Ca">Ca</option>
          <option value="Si">Si</option>
          <option value="Al">Al</option>
          <option value="Mg">Mg</option>
          <option value="Na">Na</option>
        </select>
      </div>
      <div>
        <select id="secondElement">
          <option value="">None (Show Abundance Only)</option>
          <option value="Fe">Fe</option>
          <option value="Ti">Ti</option>
          <option value="Ca">Ca</option>
          <option value="Si">Si</option>
          <option value="Al">Al</option>
          <option value="Mg">Mg</option>
          <option value="Na">Na</option>
        </select>
      </div>
      <button id="clearMap">Clear Map</button>
    </div>

    <div class="legend">
      <div id="colorScale"></div>
      <div style="display: flex; justify-content: space-between">
        <span>Low</span>
        <span>High</span>
      </div>
    </div>

    <div id="info-panel"></div>
    <div class="loading">Loading data...</div>
    <div id="globeViz"></div>

    <script>
      let currentData = [];

      // Fix Globe initialization
      const globe = new Globe(document.getElementById("globeViz"))
        .globeImageUrl("../static/lunar_surface.jpg")
        .bumpImageUrl("../static/lunar_bumpmap.jpg")
        .backgroundImageUrl(
          "https://unpkg.com/three-globe@2.24.7/example/img/night-sky.png"
        )
        .showGraticules(false)
        .showAtmosphere(false)
        .pointRadius(0.5)
        .pointColor(() => "#ff0000")
        .pointAltitude(0) // Set to 0 to make markers flat on surface
        .pointResolution(64) // Increase point resolution for smoother appearance
        .pointLabel(
          (d) => `
        <div style="
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 8px;
          border-radius: 5px;
          font-family: Arial, sans-serif;
          font-size: 12px;
          min-width: 150px;
        ">
          <div><b>Location:</b></div>
          <div>Lat: ${d.lat.toFixed(2)}°</div>
          <div>Long: ${d.lng.toFixed(2)}°</div>
          ${
            d.ratio
              ? `<div><b>Elements:</b> ${d.element1}/${d.element2}</div>
             <div><b>Ratio:</b> ${d.ratio.toFixed(3)}</div>
             <div><b>${d.element1}:</b> ${d.abundance1.toFixed(2)}%</div>
             <div><b>${d.element2}:</b> ${d.abundance2.toFixed(2)}%</div>`
              : `<div><b>Element:</b> ${d.element}</div>
             <div><b>Abundance:</b> ${d.abundance.toFixed(2)}%</div>`
          }
          <div><b>Date:</b> ${d.date || "N/A"}</div>
        </div>
      `
        )
        .onPointHover((point) => {
          document.body.style.cursor = point ? "pointer" : "default";
        });

      // Remove the additional globe(document...) call since we already passed the element

      // Initialize color scale
      const colorScale = d3
        .scaleSequential()
        .interpolator((t) => d3.interpolateRdYlBu(1 - t)) // Flip the color interpolator
        .clamp(true);

      // Update the color legend
      function updateColorScale(min, max) {
        const canvas = document.getElementById("colorScale");
        const ctx = canvas.getContext("2d");
        const gradient = ctx.createLinearGradient(0, 0, 200, 0);

        // Generate gradient stops - keeping original color scale order for the legend
        for (let i = 0; i <= 1; i += 0.1) {
          const color = d3.interpolateRdYlBu(1 - i); // Flip only the legend gradient
          gradient.addColorStop(i, color);
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 200, 20);

        const lowLabel = document.getElementById("legendMin");
        const highLabel = document.getElementById("legendHigh");
        lowLabel.textContent = min.toFixed(2);
        highLabel.textContent = max.toFixed(2);
      }

      // Replace the simple legend div with a more detailed one
      document.querySelector(".legend").innerHTML = `
      <div>
        <canvas id="colorScale" width="200" height="20"></canvas>
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <span id="legendMin">0.00</span>
          <span id="legendHigh">100.00</span>
        </div>
        <div id="legendLabel" style="text-align: center; margin-top: 5px;">
          Abundance (%)
        </div>
      </div>
    `;

      // Update legend label based on visualization type
      function updateLegendLabel(element1, element2) {
        const legendLabel = document.getElementById("legendLabel");
        if (element2) {
          legendLabel.textContent = `${element1}/${element2} Ratio`;
        } else {
          legendLabel.textContent = `${element1} Abundance (%)`;
        }
      }

      // Fetch and display data
      async function fetchData(element1, element2 = null) {
        document.querySelector(".loading").style.display = "block";

        try {
          const url = element2
            ? `/ratio?element=${element1}&element2=${element2}`
            : `/abundance?element=${element1}`;

          const response = await fetch(url);
          const data = await response.json();

          if (!data.length) {
            alert("No data available for selected elements");
            return;
          } else {
            console.log("received ", data.length, "points");
          }

          // Process data for visualization
          // // const values = element2
          // //   ? data.map((d) => d.ratio)
          // //   : data.map((d) => d.abundance);

          // // console.log("mapped succesfully");

          // // const min = Math.min(...values);
          // // console.log("min succesfully");
          // // const max = Math.max(...values);
          // console.log("max succesfully");

          const values = element2
            ? data.map((d) => d.ratio)
            : data.map((d) => d.abundance);

          console.log("mapped successfully");

          const min = values.reduce(
            (acc, val) => (val < acc ? val : acc),
            Infinity
          );
          const max = values.reduce(
            (acc, val) => (val > acc ? val : acc),
            -Infinity
          );

          console.log("min:", min);
          console.log("max:", max);

          colorScale.domain([min, max]);
          updateColorScale(min, max);
          updateLegendLabel(element1, element2);
          console.log("legend succesfully");

          // Update globe visualization with correct abundance mapping
          globe
            .pointColor((d) => colorScale(element2 ? d.ratio : d.abundance))
            .pointsData(
              data.map((d) => ({
                lat: d.lat,
                lng: d.long,
                abundance: element2 ? null : d.abundance,
                abundance1: element2 ? d.abundance1 : null,
                abundance2: element2 ? d.abundance2 : null,
                ratio: element2 ? d.ratio : null,
                date: d.date,
                element: element1,
                element1: element1,
                element2: element2,
              }))
            );

          currentData = data;

          // Update info panel
          const infoPanel = document.getElementById("info-panel");
          infoPanel.innerHTML = `
          <div>Points: ${data.length}</div>
          <div>Range: ${min.toFixed(2)} - ${max.toFixed(2)}</div>
        `;
        } catch (error) {
          console.error("Error fetching data:", error);
          alert("Error loading data");
        } finally {
          document.querySelector(".loading").style.display = "none";
        }
      }

      // Event Listeners
      document
        .getElementById("primaryElement")
        .addEventListener("change", (e) => {
          const element1 = e.target.value;
          const element2 = document.getElementById("secondElement").value;
          if (element1) fetchData(element1, element2 || null);
        });

      document
        .getElementById("secondElement")
        .addEventListener("change", (e) => {
          const element1 = document.getElementById("primaryElement").value;
          const element2 = e.target.value;
          if (element1) fetchData(element1, element2 || null);
        });

      document.getElementById("clearMap").addEventListener("click", () => {
        globe.pointsData([]);
        currentData = [];
        document.getElementById("primaryElement").value = "";
        document.getElementById("secondElement").value = "";
        document.getElementById("info-panel").innerHTML = "";
      });

      // Initialize color legend
      const canvas = document.createElement("canvas");
      canvas.id = "colorScale";
      canvas.width = 200;
      canvas.height = 20;
      document.querySelector(".legend").prepend(canvas);
      updateColorScale(0, 100);
    </script>
  </body>
</html>
